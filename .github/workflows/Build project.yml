name: Build project

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump"
        required: true
        default: x.x.1
        type: choice
        options:
          - none
          - x.x.1
          - x.1.0
          - 1.0.0

permissions:
  contents: write

concurrency:
  group: unity-build
  cancel-in-progress: false

env:
  PROJECT_NAME: project_name
  UNITY_VERSION: 6000.0.62f1
  PROJECT_PATH: unity_project

jobs:
# ==================================================
# VERSION BUMP (SINGLE SOURCE OF TRUTH)
# ==================================================
  version:
    name: Version bump
    runs-on: ubuntu-22.04

    outputs:
      version: ${{ steps.bump.outputs.version }}
      bumped: ${{ steps.bump.outputs.bumped }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump Unity bundleVersion
        id: bump
        run: |
          FILE="${{ env.PROJECT_PATH }}/ProjectSettings/ProjectSettings.asset"

          CURRENT=$(grep -m1 "bundleVersion:" "$FILE" | awk '{print $2}')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          MODE="${{ github.event.inputs.version_bump }}"
          BUMPED=false

          case "$MODE" in
            x.x.1)
              PATCH=$((PATCH+1))
              BUMPED=true
              ;;
            x.1.0)
              MINOR=$((MINOR+1))
              PATCH=0
              BUMPED=true
              ;;
            1.0.0)
              MAJOR=$((MAJOR+1))
              MINOR=0
              PATCH=0
              BUMPED=true
              ;;
            none)
              ;;
            *)
              echo "Invalid bump mode"
              exit 1
              ;;
          esac

          NEW="$MAJOR.$MINOR.$PATCH"

          if [ "$BUMPED" = true ]; then
            sed -i "s/bundleVersion:.*/bundleVersion: $NEW/" "$FILE"
          fi

          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=$BUMPED" >> $GITHUB_OUTPUT

      - name: Commit version bump
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add "${{ env.PROJECT_PATH }}/ProjectSettings/ProjectSettings.asset"
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
          git push

# ==================================================
# BUILD MATRIX
# ==================================================
  buildForAllSupportedPlatforms:
    name: Building ${{ matrix.config.label }}
    runs-on: ubuntu-22.04
    needs: version

    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        config:
          - { targetPlatform: "StandaloneWindows64", profilePath: "Assets/Settings/Build Profiles/windows-rel.asset", label: "windows-rel" }
          - { targetPlatform: "StandaloneWindows64", profilePath: "Assets/Settings/Build Profiles/windows-dev.asset", label: "windows-dev" }
          - { targetPlatform: "StandaloneLinux64",   profilePath: "Assets/Settings/Build Profiles/linux-rel.asset",   label: "linux-rel" }
          - { targetPlatform: "StandaloneLinux64",   profilePath: "Assets/Settings/Build Profiles/linux-dev.asset",   label: "linux-dev" }
          - { targetPlatform: "WebGL",                profilePath: "Assets/Settings/Build Profiles/web-rel.asset",     label: "web-rel" }
          - { targetPlatform: "WebGL",                profilePath: "Assets/Settings/Build Profiles/web-dev.asset",     label: "web-dev" }

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-${{ matrix.config.targetPlatform }}
          restore-keys: Library-

      - name: Update Unity project name
        run: |
          sed -i "s/productName:.*/productName: ${{ env.PROJECT_NAME }}/" \
            ${{ env.PROJECT_PATH }}/ProjectSettings/ProjectSettings.asset

      - name: Update JSON data
        run: |
          commit_sha=$(git rev-parse HEAD)
          mkdir -p ${{ env.PROJECT_PATH }}/Assets/Data
          jq -n --arg commit "$commit_sha" '{commit:$commit}' \
            > ${{ env.PROJECT_PATH }}/Assets/Data/data.json

      - name: Build with Unity
        uses: game-ci/unity-builder@v4
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: ${{ matrix.config.targetPlatform }}
          buildProfile: ${{ matrix.config.profilePath }}
          versioning: None
          customParameters: -logFile -
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      - name: Zip build
        run: |
          mkdir -p temp/${{ env.PROJECT_NAME }}
          cp -r build/${{ matrix.config.targetPlatform }}/* temp/${{ env.PROJECT_NAME }}/

          if [[ "${{ matrix.config.targetPlatform }}" == "StandaloneWindows64" ]]; then
            exe=$(find temp/${{ env.PROJECT_NAME }} -name '*.exe' | head -n1)
            mv "$exe" temp/${{ env.PROJECT_NAME }}/${{ env.PROJECT_NAME }}.exe || true
          fi

          cd temp
          zip -r ../${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}-${{ matrix.config.label }}.zip \
            ${{ env.PROJECT_NAME }}

      - uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.config.label }}
          path: ${{ env.PROJECT_NAME }}-${{ needs.version.outputs.version }}-${{ matrix.config.label }}.zip
          retention-days: 1

# ==================================================
# RELEASE
# ==================================================
  createRelease:
    name: Create Release
    runs-on: ubuntu-22.04
    needs: buildForAllSupportedPlatforms

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: build-*
          merge-multiple: true

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: Release v${{ needs.version.outputs.version }}
          generate_release_notes: true
          files: |
            *.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
