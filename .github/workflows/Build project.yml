name: Build project

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: unity-build
  cancel-in-progress: false

jobs:
  buildForAllSupportedPlatforms:
    name: Building ${{ matrix.config.label }}
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        config:
          - { targetPlatform: "StandaloneWindows64", profilePath: "Assets/Settings/Build Profiles/windows-rel.asset", label: "windows-rel" }
          - { targetPlatform: "StandaloneWindows64", profilePath: "Assets/Settings/Build Profiles/windows-dev.asset", label: "windows-dev" }
          - { targetPlatform: "StandaloneLinux64",   profilePath: "Assets/Settings/Build Profiles/linux-rel.asset",   label: "linux-rel" }
          - { targetPlatform: "StandaloneLinux64",   profilePath: "Assets/Settings/Build Profiles/linux-dev.asset",   label: "linux-dev" }
          - { targetPlatform: "WebGL",                profilePath: "Assets/Settings/Build Profiles/web-rel.asset",     label: "web-rel" }
          - { targetPlatform: "WebGL",                profilePath: "Assets/Settings/Build Profiles/web-dev.asset",     label: "web-dev" }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: false

      # âœ… CLEANUP (THE IMPORTANT PART)
      - name: Clean Unity workspace
        run: |
          rm -rf unity_project/Library
          rm -rf unity_project/Temp
          rm -rf unity_project/Obj
          rm -rf unity_project/Logs

      - name: Free up disk space
        uses: jlumbroso/free-disk-space@v1.3.1

      - name: Determine version
        id: version
        run: |
          git fetch --tags
          last_tag=$(git tag | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)
          [ -z "$last_tag" ] && last_tag="v0.0.0"

          branch="${{ github.ref }}"
          branch="${branch#refs/heads/}"

          if [[ "$branch" == "main" ]]; then
            base=${last_tag%.*}
            patch=${last_tag##*.}
            next_tag="${base}.$((patch + 1))"
          else
            clean_branch=$(echo "$branch" | sed 's/[^a-zA-Z0-9._-]/-/g')
            next_tag="${last_tag}-${clean_branch}"
          fi

          echo "tag=$next_tag" >> $GITHUB_OUTPUT
          echo "unity_version=${next_tag#v}" >> $GITHUB_OUTPUT

      - name: Update Unity project version
        run: |
          sed -i "s/bundleVersion: .*/bundleVersion: ${{ steps.version.outputs.unity_version }}/" \
            unity_project/ProjectSettings/ProjectSettings.asset

      - name: Update Unity project name
        run: |
          sed -i "s/productName: .*/productName: project_name/" \
            unity_project/ProjectSettings/ProjectSettings.asset

      - name: Update JSON data
        run: |
          mkdir -p unity_project/Assets/Data
          jq -n --arg commit "$(git rev-parse HEAD)" '{commit:$commit}' \
            > unity_project/Assets/Data/data.json

      - name: Build with Unity (Build Profile)
        uses: game-ci/unity-builder@v4
        with:
          projectPath: unity_project
          unityVersion: 6000.0.62f1
          targetPlatform: ${{ matrix.config.targetPlatform }}
          buildProfile: ${{ matrix.config.profilePath }}
          versioning: None
          customParameters: -logFile -
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      - name: Zip the build
        run: |
          mkdir -p temp/project_name
          cp -r build/${{ matrix.config.targetPlatform }}/* temp/project_name/

          if [[ "${{ matrix.config.targetPlatform }}" == "StandaloneWindows64" ]]; then
            exe=$(find temp/project_name -name '*.exe' | head -n1)
            mv "$exe" temp/project_name/project_name.exe || true
          fi

          cd temp
          zip -r ../project_name-${{ matrix.config.label }}.zip project_name

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.config.label }}
          path: project_name-${{ matrix.config.label }}.zip
          retention-days: 1

  generateChangelog:
    name: Generate Changelog
    runs-on: ubuntu-22.04
    needs: buildForAllSupportedPlatforms

    outputs:
      version: ${{ steps.version.outputs.tag }}
      changelog: ${{ steps.changelog.outputs.content }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version tag
        id: version
        run: |
          git fetch --tags
          last_tag=$(git tag | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)
          [ -z "$last_tag" ] && last_tag="v0.0.0"
          echo "tag=$last_tag" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          log=$(git log ${{ github.event.before }}..${{ github.sha }} --pretty=format:'**%h** - %s%n')
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$log" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  createRelease:
    name: Create Release
    runs-on: ubuntu-22.04
    needs: generateChangelog

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: build-*
          merge-multiple: true

      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.generateChangelog.outputs.version }}
          name: Release ${{ needs.generateChangelog.outputs.version }}
          body: ${{ needs.generateChangelog.outputs.changelog }}
          files: project_name-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
