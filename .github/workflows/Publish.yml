name: Publish

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Select platform to build"
        required: true
        default: all
        type: choice
        options:
          - all
          - windows
          - android

      version_bump:
        description: "Version bump"
        required: true
        default: none
        type: choice
        options:
          - none
          - x.x.1
          - x.1.0
          - 1.0.0

jobs:
# ==================================================
# VERSION BUMP
# ==================================================
  version:
    name: Version Control
    runs-on: [self-hosted, linux, x64]

    outputs:
      new_version: ${{ steps.bump.outputs.version }}
      bumped: ${{ steps.bump.outputs.bumped }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bump Unity bundleVersion
        id: bump
        run: |
          FILE="ProjectDawn/ProjectSettings/ProjectSettings.asset"

          CURRENT=$(grep -m1 "bundleVersion:" "$FILE" | awk '{print $2}')
          echo "Current version: $CURRENT"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          MODE="${{ github.event.inputs.version_bump }}"
          BUMPED=false

          case "$MODE" in
            "x.x.1")
              PATCH=$((PATCH + 1))
              BUMPED=true
              ;;
            "x.1.0")
              MINOR=$((MINOR + 1))
              PATCH=0
              BUMPED=true
              ;;
            "1.0.0")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              BUMPED=true
              ;;
            "none")
              echo "Skipping version bump"
              ;;
            *)
              echo "Invalid version bump option: $MODE"
              exit 1
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"

          if [ "$BUMPED" = true ]; then
            sed -i "s/bundleVersion: .*/bundleVersion: $NEW_VERSION/" "$FILE"
            echo "Updated version to $NEW_VERSION"
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bumped=$BUMPED" >> $GITHUB_OUTPUT

      - name: Commit version bump
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add ProjectDawn/ProjectSettings/ProjectSettings.asset
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
          git push

# ==================================================
# WINDOWS BUILD
# ==================================================
  windows:
    name: Build Windows
    needs: version
    if: github.event.inputs.platform == 'windows' || github.event.inputs.platform == 'all'
    runs-on: [self-hosted, linux, x64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: ProjectDawn/Library
          key: Library-windows
          restore-keys: Library-

      - name: Build Windows
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ProjectDawn
          targetPlatform: StandaloneWindows64
          buildMethod: CIBuilder.BuildWindows

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: ProjectDawn/Builds/

# ==================================================
# ANDROID BUILD
# ==================================================
  android:
    name: Build Android
    needs: version
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all'
    runs-on: [self-hosted, linux, x64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: ProjectDawn/Library
          key: Library-android
          restore-keys: Library-

      - name: Build Android
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ProjectDawn
          targetPlatform: Android
          buildMethod: CIBuilder.BuildAndroid

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: ProjectDawn/Builds/

# ==================================================
# CLEANUP (ALWAYS RUNS)
# ==================================================
  cleanup:
    name: Cleanup Runner
    runs-on: [self-hosted, linux, x64]
    needs: [windows, android]
    if: always()

    steps:
      - name: Cleanup Unity workspace
        run: |
          echo "ðŸ§¹ Cleaning Unity workspace..."
          rm -rf ProjectDawn/Library
          rm -rf ProjectDawn/Temp
          rm -rf ProjectDawn/Logs
          rm -rf ProjectDawn/Builds
          echo "âœ… Cleanup complete"

# ==================================================
# GITHUB RELEASE
# ==================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [version, windows, android]
    if: always()

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.new_version }}
          name: Release v${{ needs.version.outputs.new_version }}
          generate_release_notes: true
          files: |
            dist/windows/**
            dist/android/**
