name: Publish

env:
  PROJECT_PATH: unity_project

on:
  workflow_dispatch:
    inputs:
      platform:

      version_bump:
        description: "Version bump"
        required: true
        default: x.x.1
        type: choice
        options: [none, x.x.1, x.1.0, 1.0.0]

jobs:
# ==================================================
# VERSION BUMP
# ==================================================
  version:
    runs-on: [self-hosted, linux, x64]
    outputs:
      new_version: ${{ steps.bump.outputs.version }}
      bumped: ${{ steps.bump.outputs.bumped }}

    steps:
      - uses: actions/checkout@v4

      - name: Bump Unity bundleVersion
        id: bump
        run: |
          FILE="ProjectDawn/ProjectSettings/ProjectSettings.asset"
          CURRENT=$(grep -m1 "bundleVersion:" "$FILE" | awk '{print $2}')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          MODE="${{ github.event.inputs.version_bump }}"
          BUMPED=false
          case "$MODE" in
            x.x.1) PATCH=$((PATCH+1)); BUMPED=true ;;
            x.1.0) MINOR=$((MINOR+1)); PATCH=0; BUMPED=true ;;
            1.0.0) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0; BUMPED=true ;;
            none) ;;
            *) exit 1 ;;
          esac
          NEW="$MAJOR.$MINOR.$PATCH"
          if [ "$BUMPED" = true ]; then
            sed -i "s/bundleVersion:.*/bundleVersion: $NEW/" "$FILE"
          fi
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=$BUMPED" >> $GITHUB_OUTPUT
      - name: Commit version bump
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add ProjectDawn/ProjectSettings/ProjectSettings.asset
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
          git push

# ==================================================
# Build
# ==================================================
          
  buildForAllSupportedPlatforms:
    name: Building ${{ matrix.config.label }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - { targetPlatform: "StandaloneWindows64", profilePath: "Assets/Settings/Build Profiles/windows-rel.asset", label: "windows-rel" }
          - { targetPlatform: "StandaloneWindows64", profilePath: "Assets/Settings/Build Profiles/windows-dev.asset", label: "windows-dev" }
          - { targetPlatform: "StandaloneLinux64", profilePath: "Assets/Settings/Build Profiles/linux-rel.asset", label: "linux-rel" }
          - { targetPlatform: "StandaloneLinux64", profilePath: "Assets/Settings/Build Profiles/linux-dev.asset", label: "linux-dev" }
          - { targetPlatform: "WebGL", profilePath: "Assets/Settings/Build Profiles/web-rel.asset", label: "web-rel" }
          - { targetPlatform: "WebGL", profilePath: "Assets/Settings/Build Profiles/web-dev.asset", label: "web-dev" }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: false
          
      - name: Cache Library
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-${{ matrix.targetPlatform }}
          restore-keys: Library-

      - name: Free up disk space
        uses: jlumbroso/free-disk-space@v1.3.1

      - name: Build with Unity (Build Profile)
        uses: game-ci/unity-builder@v4
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          targetPlatform: ${{ matrix.config.targetPlatform }}
          buildProfile: ${{ matrix.config.profilePath }}
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      
      - uses: actions/upload-artifact@v4
        with:
          name: android
          path: ProjectDawn/Builds/

# ==================================================
# RELEASE (NO UNITY, NO SELF-HOSTED)
# ==================================================
  release:
    needs: [version, buildForAllSupportedPlatforms]
    runs-on: [self-hosted, linux, x64]
    if: always()

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.new_version }}
          name: Release v${{ needs.version.outputs.new_version }}
          generate_release_notes: true
          files: |
            dist/windows/**
            dist/android/**
