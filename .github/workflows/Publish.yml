name: Publish

env:
  PROJECT_PATH: ProjectDawn

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump"
        required: true
        default: x.x.1
        type: choice
        options:
          - none
          - x.x.1
          - x.1.0
          - 1.0.0

# ==================================================
# VERSION BUMP
# ==================================================
jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.version }}
      bumped: ${{ steps.bump.outputs.bumped }}

    steps:
      - uses: actions/checkout@v4

      - name: Bump Unity bundleVersion
        id: bump
        run: |
          FILE="ProjectDawn/ProjectSettings/ProjectSettings.asset"

          CURRENT=$(grep -m1 "bundleVersion:" "$FILE" | awk '{print $2}')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          MODE="${{ github.event.inputs.version_bump }}"
          BUMPED=false

          case "$MODE" in
            x.x.1)
              PATCH=$((PATCH + 1))
              BUMPED=true
              ;;
            x.1.0)
              MINOR=$((MINOR + 1))
              PATCH=0
              BUMPED=true
              ;;
            1.0.0)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              BUMPED=true
              ;;
            none)
              ;;
            *)
              echo "Invalid version bump"
              exit 1
              ;;
          esac

          NEW="$MAJOR.$MINOR.$PATCH"

          if [ "$BUMPED" = true ]; then
            sed -i "s/bundleVersion:.*/bundleVersion: $NEW/" "$FILE"
          fi

          echo "version=$NEW" >> "$GITHUB_OUTPUT"
          echo "bumped=$BUMPED" >> "$GITHUB_OUTPUT"

      - name: Commit version bump
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add ProjectDawn/ProjectSettings/ProjectSettings.asset
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
          git push

# ==================================================
# BUILD ALL PLATFORMS
# ==================================================
  build:
    needs: version
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - { platform: StandaloneWindows64, label: windows-rel }
          - { platform: StandaloneLinux64,  label: linux-rel }
          - { platform: WebGL,              label: web-rel }
          - { platform: Android,            label: android-rel }

    name: Build ${{ matrix.config.label }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free disk space
        uses: jlumbroso/free-disk-space@v1.3.1

      - name: Build with Unity
        uses: game-ci/unity-builder@v4
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          targetPlatform: ${{ matrix.config.platform }}
          androidExportType: androidPackage
          androidSymbolType: none
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      # =============================
      # PACKAGE OUTPUTS (IMPORTANT)
      # =============================
      - name: Package build artifacts
        run: |
          mkdir -p packaged

          case "${{ matrix.config.platform }}" in
            StandaloneWindows64)
              zip -r packaged/ProjectDawn-${{ matrix.config.label }}.zip ProjectDawn/Builds/StandaloneWindows64
              ;;
            StandaloneLinux64)
              zip -r packaged/ProjectDawn-${{ matrix.config.label }}.zip ProjectDawn/Builds/StandaloneLinux64
              ;;
            WebGL)
              zip -r packaged/ProjectDawn-${{ matrix.config.label }}.zip ProjectDawn/Builds/WebGL
              ;;
            Android)
              cp ProjectDawn/Builds/Android/*.apk packaged/
              ;;
          esac

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.config.label }}
          path: packaged/*

# ==================================================
# RELEASE (NO UNITY)
# ==================================================
  release:
    needs: [version, build]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.new_version }}
          name: Release v${{ needs.version.outputs.new_version }}
          generate_release_notes: true
          files: |
            dist/**/*.zip
            dist/**/*.apk
