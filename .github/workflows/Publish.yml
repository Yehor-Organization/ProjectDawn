name: Publish

concurrency:
  group: unity-build
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Select platform to build"
        required: true
        default: all
        type: choice
        options: [all, windows, android]

      version_bump:
        description: "Version bump"
        required: true
        default: x.x.1
        type: choice
        options: [none, x.x.1, x.1.0, 1.0.0]

jobs:
# ==================================================
# VERSION BUMP (NO UNITY, NO SELF-HOSTED)
# ==================================================
  version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.version }}
      bumped: ${{ steps.bump.outputs.bumped }}

    steps:
      - uses: actions/checkout@v4

      - name: Bump Unity bundleVersion
        id: bump
        run: |
          FILE="ProjectDawn/ProjectSettings/ProjectSettings.asset"
          CURRENT=$(grep -m1 "bundleVersion:" "$FILE" | awk '{print $2}')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          MODE="${{ github.event.inputs.version_bump }}"
          BUMPED=false

          case "$MODE" in
            x.x.1) PATCH=$((PATCH+1)); BUMPED=true ;;
            x.1.0) MINOR=$((MINOR+1)); PATCH=0; BUMPED=true ;;
            1.0.0) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0; BUMPED=true ;;
            none) ;;
            *) exit 1 ;;
          esac

          NEW="$MAJOR.$MINOR.$PATCH"

          if [ "$BUMPED" = true ]; then
            sed -i "s/bundleVersion:.*/bundleVersion: $NEW/" "$FILE"
          fi

          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=$BUMPED" >> $GITHUB_OUTPUT

      - name: Commit version bump
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add ProjectDawn/ProjectSettings/ProjectSettings.asset
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
          git push

# ==================================================
# WINDOWS BUILD (SELF-HOSTED, EPHEMERAL)
# ==================================================
  windows:
    needs: version
    if: github.event.inputs.platform != 'android'
    runs-on: [self-hosted, linux, x64]

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - uses: actions/cache@v4
        with:
          path: ProjectDawn/Library
          key: Library-windows

      - uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_BUILDER_DOCKER_USER: "${{ runner.uid }}:${{ runner.gid }}"
        with:
          projectPath: ProjectDawn
          targetPlatform: StandaloneWindows64
          buildMethod: CIBuilder.BuildWindows

      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: ProjectDawn/Builds/

# ==================================================
# ANDROID BUILD (SELF-HOSTED, EPHEMERAL)
# ==================================================
  android:
    needs: windows
    if: github.event.inputs.platform != 'windows'
    runs-on: [self-hosted, linux, x64]

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - uses: actions/cache@v4
        with:
          path: ProjectDawn/Library
          key: Library-android

      - uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          UNITY_BUILDER_DOCKER_USER: "${{ runner.uid }}:${{ runner.gid }}"
        with:
          projectPath: ProjectDawn
          targetPlatform: Android
          buildMethod: CIBuilder.BuildAndroid

      - uses: actions/upload-artifact@v4
        with:
          name: android
          path: ProjectDawn/Builds/

# ==================================================
# RELEASE (NO UNITY, NO SELF-HOSTED)
# ==================================================
  release:
    needs: [version, windows, android]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.new_version }}
          name: Release v${{ needs.version.outputs.new_version }}
          generate_release_notes: true
          files: |
            dist/windows/**
            dist/android/**
