name: Clean Releases

on:
  workflow_dispatch:

permissions:
  contents: write   # REQUIRED for deleting tags
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =============================
      # AUTH GH CLI EXPLICITLY
      # =============================
      - name: Authenticate gh
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      # =============================
      # KEEP HIGHEST PATCH PER MAJOR.MINOR
      # =============================
      - name: Keep highest patch per major.minor and delete the rest
        shell: bash
        run: |
          set -euo pipefail

          echo "üì¶ Fetching release tags..."
          tags=$(gh release list \
            --repo "$GITHUB_REPOSITORY" \
            --limit 1000 \
            --json tagName \
            --jq '.[].tagName')

          declare -A keep_tag

          for tag in $tags; do
            if [[ "$tag" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              major="${BASH_REMATCH[1]}"
              minor="${BASH_REMATCH[2]}"
              patch="${BASH_REMATCH[3]}"
              key="${major}.${minor}"

              existing="${keep_tag[$key]:-}"
              if [[ -z "$existing" ]]; then
                keep_tag[$key]="$tag"
              else
                [[ "$existing" =~ ^v${major}\.${minor}\.([0-9]+)$ ]]
                existing_patch="${BASH_REMATCH[1]}"
                (( patch > existing_patch )) && keep_tag[$key]="$tag"
              fi
            fi
          done

          echo ""
          echo "‚úÖ Keeping releases:"
          for t in "${keep_tag[@]}"; do
            echo "  ‚Ä¢ $t"
          done

          echo ""
          echo "üóëÔ∏è Deleting old patch releases..."
          for tag in $tags; do
            keep=false
            for k in "${keep_tag[@]}"; do
              [[ "$tag" == "$k" ]] && keep=true && break
            done

            if [[ "$keep" == false ]]; then
              echo "Deleting release + tag: $tag"
              gh release delete "$tag" --repo "$GITHUB_REPOSITORY" --yes || true
              git push origin --delete "$tag" || true
            fi
          done

      # =============================
      # DELETE ORPHAN TAGS (NO RELEASE)
      # =============================
      - name: Delete orphan tags (no GitHub release)
        shell: bash
        run: |
          set -euo pipefail

          git fetch --tags

          all_tags=$(git tag)
          release_tags=$(gh release list \
            --repo "$GITHUB_REPOSITORY" \
            --limit 1000 \
            --json tagName \
            --jq '.[].tagName')

          echo ""
          echo "üßπ Cleaning orphan tags..."

          for tag in $all_tags; do
            found=false
            for r in $release_tags; do
              [[ "$tag" == "$r" ]] && found=true && break
            done

            if [[ "$found" == false ]]; then
              echo "Deleting orphan tag: $tag"
              git push origin --delete "$tag" || true
            fi
          done

      # =============================
      # INTENTIONAL FAILURE
      # =============================
      - name: üö® Fail intentionally
        run: |
          echo "::error title=Intentional Failure::Cleanup workflow failed on purpose"
          exit 1
