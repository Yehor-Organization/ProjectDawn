name: Clean Releases

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Keep highest patch per major.minor and delete the rest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -e

          echo "üì¶ Fetching release tags..."
          tags=$(gh release list \
            --repo "$GITHUB_REPOSITORY" \
            --limit 1000 \
            --json tagName \
            --jq '.[].tagName')

          declare -A keep_tag

          # Determine highest patch for each major.minor
          for tag in $tags; do
            tag=${tag//\"/}

            if [[ "$tag" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              major="${BASH_REMATCH[1]}"
              minor="${BASH_REMATCH[2]}"
              patch="${BASH_REMATCH[3]}"
              key="${major}.${minor}"

              existing="${keep_tag[$key]}"

              if [[ -z "$existing" ]]; then
                keep_tag[$key]="$tag"
              else
                if [[ "$existing" =~ ^v${major}\.${minor}\.([0-9]+)$ ]]; then
                  existing_patch="${BASH_REMATCH[1]}"
                  if (( patch > existing_patch )); then
                    keep_tag[$key]="$tag"
                  fi
                fi
              fi
            fi
          done

          echo ""
          echo "‚úÖ Keeping:"
          for t in "${keep_tag[@]}"; do
            echo "  ‚Ä¢ $t"
          done

          echo ""
          echo "üóëÔ∏è Deleting old patch releases..."

          for tag in $tags; do
            tag=${tag//\"/}
            keep=false

            for kept in "${keep_tag[@]}"; do
              [[ "$tag" == "$kept" ]] && keep=true && break
            done

            if [[ "$keep" == false ]]; then
              echo "Deleting release + tag: $tag"
              gh release delete "$tag" --repo "$GITHUB_REPOSITORY" --yes || true
              git push origin --delete "$tag" || true
            fi
          done

      - name: Delete orphan tags (no GitHub release)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -e

          git fetch --tags

          all_tags=$(git tag)
          release_tags=$(gh release list \
            --repo "$GITHUB_REPOSITORY" \
            --limit 1000 \
            --json tagName \
            --jq '.[].tagName')

          echo ""
          echo "üßπ Cleaning orphan tags..."

          for tag in $all_tags; do
            found=false
            for r in $release_tags; do
              r=${r//\"/}
              [[ "$tag" == "$r" ]] && found=true && break
            done

            if [[ "$found" == false ]]; then
              echo "Deleting orphan tag: $tag"
              git push origin --delete "$tag" || true
            fi
          done

          
      - name: üö® Fail intentionally
        run: |
          echo "::error title=Intentional Failure::This workflow failed on purpose for cleanup testing"
          exit 1
